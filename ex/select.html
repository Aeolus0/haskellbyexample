<!DOCTYPE html><html><head><title>Haskell by Example: Select</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/prism.css"><script src="/js/prism.js"></script></head><body><div class="example"><h1>Haskell by Example: Select</h1><a href="https://gobyexample.com/select">original</a><pre><code class="language-haskell">{-# LANGUAGE GADTs #-}
import Control.Monad
import Control.Concurrent

main = do
    c1 &lt;- newEmptyMVar
    c2 &lt;- newEmptyMVar

    forkIO $ do
        threadDelay (1 * 1000000)
        putMVar c1 &quot;one&quot;

    forkIO $ do
        threadDelay (2 * 1000000)
        putMVar c2 &quot;two&quot;

    forM_ [0..1] $ \i -&gt;
        select [ Case c1 $ \msg1 -&gt; putStrLn $ &quot;received &quot; ++ msg1
               , Case c2 $ \msg2 -&gt; putStrLn $ &quot;received &quot; ++ msg2
               ]

data Select a where
    Default :: IO a -&gt; Select a
    Case    :: MVar b -&gt; (b -&gt; IO a) -&gt; Select a

select :: [Select a] -&gt; IO a
select [] = error &quot;select: empty list&quot;
select ((Default x):_) = x
select (x@(Case v f):xs)  = do
    var &lt;- tryTakeMVar v
    case var of
        Just b  -&gt; f b
        Nothing -&gt; select (xs ++ [x])
</code></pre>
<pre><code class="language-bash">$ time runhaskell select.hs
received one
received two

real    0m2.266s
</code></pre><a href="/">back to index</a></div></body></html>