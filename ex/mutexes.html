<!DOCTYPE html><html><head><title>Haskell by Example: Mutexes</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/prism.css"><script src="/js/prism.js"></script></head><body><div class="example"><h1>Haskell by Example: Mutexes</h1><a href="https://gobyexample.com/mutexes">original</a><pre><code class="language-haskell">import Control.Monad
import Control.Concurrent
import Control.Concurrent.STM
import System.Random
import Data.IORef
import Data.Maybe
import qualified Data.Map as Map

main = do
    state &lt;- newMVar Map.empty
    ops &lt;- atomically $ newTVar 0

    forM_ [0..99] $ \_ -&gt; do
        total &lt;- newIORef 0
        forkIO . forever $ do
            key &lt;- randomRIO (0, 4) :: IO Int
            s &lt;- takeMVar state
            let v = maybe 0 id $ Map.lookup key s
            modifyIORef total(+v)
            putMVar state s
            atomically $ do
                x &lt;- readTVar ops
                writeTVar ops (x + 1)

    forM_ [0..9] $ \_ -&gt; do
        forkIO . forever $ do
            key &lt;- randomRIO (0, 4) :: IO Int
            val &lt;- randomRIO (0, 99) :: IO Int
            s &lt;- takeMVar state
            let s&#39; = Map.insert key val s
            putMVar state s&#39;
            atomically $ do
                x &lt;- readTVar ops
                writeTVar ops (x + 1)


    threadDelay 1000000
    opsFinal &lt;- atomically $ readTVar ops
    putStrLn $ &quot;ops: &quot; ++ show opsFinal

    s &lt;- takeMVar state
    putStrLn $ &quot;state: &quot; ++ show s
</code></pre>
<pre><code class="language-bash">$ runhaskell mutexes.hs
ops: 295124
state: fromList [(0,26),(1,66),(2,75),(3,96),(4,63)]
</code></pre><a href="/">back to index</a></div></body></html>